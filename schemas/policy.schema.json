{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://openguard.dev/schemas/policy.schema.json",
  "title": "Policy",
  "description": "OpenGuard least-privilege policy file format",
  "type": "object",
  "required": ["version", "defaults", "allow"],
  "properties": {
    "version": {
      "type": "string",
      "enum": ["v1"],
      "description": "Policy schema version"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable policy name"
        },
        "description": {
          "type": "string",
          "description": "Policy description"
        },
        "created": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 creation timestamp"
        },
        "author": {
          "type": "string",
          "description": "Policy author or team"
        }
      },
      "additionalProperties": false
    },
    "defaults": {
      "type": "object",
      "required": ["action", "require_approval_for"],
      "properties": {
        "action": {
          "type": "string",
          "enum": ["deny", "allow"],
          "description": "Default action for unmatched requests"
        },
        "require_approval_for": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "shell_exec",
              "new_domain",
              "credential_paths",
              "file_write",
              "elevated_privilege"
            ]
          },
          "description": "Categories that require explicit approval"
        }
      },
      "additionalProperties": false
    },
    "allow": {
      "type": "object",
      "properties": {
        "commands": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["cmd"],
            "properties": {
              "cmd": {
                "type": "string",
                "description": "Command executable name"
              },
              "args": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Allowed argument patterns (* for wildcard, ** for rest)"
              },
              "description": {
                "type": "string",
                "description": "Why this command is allowed"
              }
            },
            "additionalProperties": false
          },
          "description": "Allowed commands and argument patterns"
        },
        "paths": {
          "type": "object",
          "properties": {
            "read": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Glob patterns for allowed read paths"
            },
            "write": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Glob patterns for allowed write paths"
            }
          },
          "additionalProperties": false,
          "description": "Allowed file system access patterns"
        },
        "network": {
          "type": "object",
          "properties": {
            "domains": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Allowed domain names (* prefix for subdomain wildcards)"
            },
            "ports": {
              "type": "array",
              "items": {
                "type": "integer",
                "minimum": 1,
                "maximum": 65535
              },
              "description": "Allowed network ports"
            }
          },
          "additionalProperties": false,
          "description": "Allowed network access"
        }
      },
      "additionalProperties": false,
      "description": "Explicit allowlist for operations"
    },
    "deny": {
      "type": "object",
      "properties": {
        "commands": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["cmd"],
            "properties": {
              "cmd": {
                "type": "string"
              },
              "args": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            },
            "additionalProperties": false
          },
          "description": "Explicitly denied commands (overrides allow)"
        },
        "paths": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Explicitly denied path patterns (overrides allow)"
        },
        "network": {
          "type": "object",
          "properties": {
            "domains": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "additionalProperties": false,
          "description": "Explicitly denied network destinations"
        }
      },
      "additionalProperties": false,
      "description": "Explicit deny list (overrides allow)"
    },
    "approvals": {
      "type": "object",
      "properties": {
        "shell_exec": {
          "$ref": "#/$defs/approval_config"
        },
        "new_domain": {
          "$ref": "#/$defs/approval_config"
        },
        "credential_paths": {
          "$ref": "#/$defs/approval_config"
        },
        "file_write": {
          "$ref": "#/$defs/approval_config"
        },
        "elevated_privilege": {
          "$ref": "#/$defs/approval_config"
        }
      },
      "additionalProperties": false,
      "description": "Approval configuration per category"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "approval_config": {
      "type": "object",
      "required": ["mode"],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["auto", "prompt", "2-step", "deny"],
          "description": "Approval mode: auto (log only), prompt (Y/N), 2-step (confirm twice), deny (hard block)"
        },
        "except_allowlisted": {
          "type": "boolean",
          "default": true,
          "description": "If true, allowlisted items skip approval"
        }
      },
      "additionalProperties": false
    }
  }
}
