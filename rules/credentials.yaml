# OpenGuard Rules â€” Credentials
# These rules detect access to credential files and secret exposure.

rules:
  - id: OG-CRED-001
    title: "Reads common credential paths"
    description: "Detects read access to well-known credential storage locations. Skills should never need to read user credential files."
    severity: critical
    confidence: high
    category: credentials
    scope:
      file_types: [shell, powershell, python, javascript, typescript, yaml-workflow]
    patterns:
      - regex: '(cat|less|more|head|tail|cp|scp|rsync)\s+[^\s]*\.ssh/(id_rsa|id_ed25519|id_ecdsa|known_hosts|authorized_keys|config)'
        description: "Reading SSH key files"
      - regex: '(cat|less|more|head|tail|cp)\s+[^\s]*\.gnupg/'
        description: "Reading GPG key files"
      - regex: '(cat|less|more|head|tail|cp)\s+[^\s]*\.aws/(credentials|config)'
        description: "Reading AWS credential files"
      - regex: '(cat|less|more|head|tail|cp)\s+[^\s]*\.kube/config'
        description: "Reading Kubernetes config"
      - regex: '(cat|less|more|head|tail|cp)\s+[^\s]*\.config/gcloud/'
        description: "Reading GCP credentials"
    remediation: "Skills should never access user credential files. Use environment variables or credential helpers instead."
    tags: [credentials, theft, critical]

  - id: OG-CRED-002
    title: "Environment / token dump"
    description: "Detects commands that dump the full process environment, potentially exposing API keys and tokens."
    severity: high
    confidence: medium
    category: credentials
    scope:
      file_types: [shell, yaml-workflow]
    patterns:
      - regex: '\b(env|printenv)\s*(\||>|$)'
        description: "Environment dump to pipe, file, or stdout"
      - regex: '\bset\s*(\||>|$)'
        description: "Shell set dump"
      - regex: 'cat\s+/proc/\d+/environ'
        description: "Reading /proc environment"
      - regex: 'cat\s+/proc/self/environ'
        description: "Reading own process environment"
    remediation: "Access only specific, named environment variables instead of dumping all"
    tags: [credentials, environment]

  - id: OG-CRED-003
    title: ".env file access"
    description: "Detects reading or sourcing .env files, which typically contain application secrets and API keys."
    severity: high
    confidence: high
    category: credentials
    scope:
      file_types: [shell, yaml-workflow, dockerfile]
    patterns:
      - regex: '(cat|source|\.)\s+[^\s]*\.env\b'
        description: "Reading or sourcing .env file"
      - regex: 'cp\s+[^\s]*\.env\s+'
        description: "Copying .env file"
      - regex: 'curl\s+.*--data-binary\s+@[^\s]*\.env'
        description: "Uploading .env file"
    remediation: "Use environment-specific variable injection instead of reading .env files directly"
    tags: [credentials, dotenv, secrets]

  - id: OG-CRED-004
    title: "Git credential exposure"
    description: "Detects access to git credential storage, which may contain authentication tokens."
    severity: high
    confidence: medium
    category: credentials
    scope:
      file_types: [shell, python]
    patterns:
      - regex: '(cat|less|cp)\s+[^\s]*\.git-credentials'
        description: "Reading .git-credentials file"
      - regex: '(cat|less|cp)\s+[^\s]*\.netrc'
        description: "Reading .netrc file (contains git/FTP credentials)"
      - regex: 'git\s+config\s+--global\s+credential\.helper\s+store'
        description: "Setting git to store credentials in plaintext"
    remediation: "Use SSH keys or credential helpers with timeout (cache) instead of plaintext storage"
    tags: [credentials, git]
